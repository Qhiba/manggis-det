<!DOCTYPE html>
<html>
    <head>
        <title>Camera Access</title>
        <style>
            .container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                text-align: center;
            }
            #video {
                width: 100%;
                max-width: 640px;
                margin-bottom: 20px;
            }
            #canvas {
                display: none;
            }
            .button {
                padding: 10px 20px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px;
            }
            .button:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }
            .button.stop {
                background-color: #f44336;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Camera Access</h1>
            <video id="video" autoplay></video>
            <canvas id="canvas"></canvas>
            <div>
                <button id="startButton" class="button">Start Camera</button>
                <button id="detectButton" class="button" disabled>Detect Objects</button>
            </div>
        </div>

        <script>
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const startButton = document.getElementById('startButton');
            const detectButton = document.getElementById('detectButton');
            let stream = null;

            const updateButtonState = (streaming) => {
                if (streaming) {
                    startButton.textContent = 'Stop Camera';
                    startButton.classList.add('stop');
                    detectButton.disabled = false;
                } else {
                    startButton.textContent = 'Start Camera';
                    startButton.classList.remove('stop');
                    detectButton.disabled = true;
                }
            }

            const stopStream = () => {
                if (stream) {
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                    video.srcObject = null;
                    stream = null;
                    updateButtonState(false);
                }
            };

            const startStream = async () => {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: true
                    });
                    video.srcObject = stream;
                    updateButtonState(true);
                } catch (err) {
                    if (err.name !== 'NotAllowedError') {
                        alert('Error accessing camera. Please ensure you have given camera permission.');
                    } else {
                        alert('Error accessing camera. Please check you camera connection.');
                    }
                    stopStream();
                }
            };

            startButton.addEventListener('click', () => {
                if (stream) {
                    stopStream();
                } else {
                    startStream();
                }
            });

            // Cleanup when page is unloaded (closed or refreshed)
            window.addEventListener('beforeunload', stopStream);
            
            // Cleanup when page visibility changes (tab switched, minimized)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopStream();
                }
            });

            // Cleanup when page is about to be discarded
            document.addEventListener('freeze', stopStream);
        </script>
    </body>
</html>